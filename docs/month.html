<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Trading Performance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .profit { color: #10b981; }
        .loss { color: #ef4444; }
        
        .metric-card, .content-card {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px var(--shadow-color);
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
        }
        
        .calendar-day {
            aspect-ratio: 1;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .calendar-day:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .metric-card {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        /* Tooltip Styles */
        .tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) scale(0.9);
            background: rgba(17, 24, 39, 0.95);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 400;
            max-width: 220px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 50;
            pointer-events: none;
            white-space: normal;
            text-align: center;
            line-height: 1.5;
            backdrop-filter: blur(8px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(17, 24, 39, 0.95);
        }
        
        .tooltip-trigger {
            position: relative;
            cursor: help;
        }
        
        .tooltip-visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Dark Mode Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
        </svg>
    </button>
    
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Navigation -->
        <nav class="mb-8 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-blue-600 hover:underline flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Dashboard
                </a>
                <span class="text-gray-400">|</span>
                <span id="monthTitle" class="text-xl font-bold text-gray-800">Loading...</span>
            </div>
            <div class="flex items-center space-x-2">
                <button id="prevMonth" class="p-2 rounded-lg bg-white shadow hover:shadow-md transition-shadow">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <button id="nextMonth" class="p-2 rounded-lg bg-white shadow hover:shadow-md transition-shadow">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
        </nav>
        
        <!-- Monthly Metrics -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6">
            <div class="metric-card rounded-lg shadow p-4 fade-in" style="animation-delay: 0.1s">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-medium text-gray-500 uppercase">Month P&L</h3>
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <p id="monthPnl" class="text-2xl font-bold text-gray-800">Loading...</p>
                <p class="text-xs text-gray-500 mt-1">This month</p>
            </div>
            
            <div class="metric-card rounded-lg shadow p-4 fade-in" style="animation-delay: 0.2s">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-medium text-gray-500 uppercase">Trades</h3>
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <p id="monthTrades" class="text-2xl font-bold text-gray-800">Loading...</p>
                <p class="text-xs text-gray-500 mt-1">This month</p>
            </div>
            
            <div class="metric-card rounded-lg shadow p-4 fade-in" style="animation-delay: 0.3s">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-medium text-gray-500 uppercase">Win Rate</h3>
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                </div>
                <p id="monthWinRate" class="text-2xl font-bold text-gray-800">Loading...</p>
                <p class="text-xs text-gray-500 mt-1">Success rate</p>
            </div>
            
            <div class="metric-card rounded-lg shadow p-4 fade-in" style="animation-delay: 0.4s">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-medium text-gray-500 uppercase">Best Day</h3>
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                    </svg>
                </div>
                <p id="bestDay" class="text-2xl font-bold text-green-600">Loading...</p>
                <p class="text-xs text-gray-500 mt-1">Highest profit</p>
            </div>
            
            <div class="metric-card rounded-lg shadow p-4 fade-in" style="animation-delay: 0.5s">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-medium text-gray-500 uppercase">Worst Day</h3>
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                    </svg>
                </div>
                <p id="worstDay" class="text-2xl font-bold text-red-600">Loading...</p>
                <p class="text-xs text-gray-500 mt-1">Biggest loss</p>
            </div>
            
            <div class="metric-card rounded-lg shadow p-4 fade-in" style="animation-delay: 0.6s">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-medium text-gray-500 uppercase">Trading Days</h3>
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <p id="tradingDays" class="text-2xl font-bold text-gray-800">Loading...</p>
                <p class="text-xs text-gray-500 mt-1">Active days</p>
            </div>
        </div>
        
        <!-- Monthly Calendar -->
        <div class="content-card rounded-xl shadow-lg p-6 mb-8 fade-in" style="animation-delay: 0.7s">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Trading Calendar</h2>
            <div id="monthCalendar" class="grid grid-cols-7 gap-2">
                <!-- Calendar will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Daily P&L Chart -->
        <div class="content-card rounded-xl shadow-lg p-6 mb-8 fade-in" style="animation-delay: 0.8s">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Daily P&L Chart</h2>
            <div class="chart-container" style="height: 300px;">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
        
        <!-- Top Trades of the Month -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
            <!-- Top Winners -->
            <div class="content-card rounded-xl shadow-lg p-6 fade-in" style="animation-delay: 0.9s">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Best Trades This Month
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-2 font-medium text-gray-700">Symbol</th>
                                <th class="text-left py-3 px-2 font-medium text-gray-700">Date</th>
                                <th class="text-left py-3 px-2 font-medium text-gray-700">Type</th>
                                <th class="text-right py-3 px-2 font-medium text-gray-700">P&L</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyWinners" class="divide-y divide-gray-100">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Top Losers -->
            <div class="content-card rounded-xl shadow-lg p-6 fade-in" style="animation-delay: 1.0s">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Worst Trades This Month
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-2 font-medium text-gray-700">Symbol</th>
                                <th class="text-left py-3 px-2 font-medium text-gray-700">Date</th>
                                <th class="text-left py-3 px-2 font-medium text-gray-700">Type</th>
                                <th class="text-right py-3 px-2 font-medium text-gray-700">P&L</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyLosers" class="divide-y divide-gray-100">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- AI Trading Coach Section -->
        <div id="coachingSection" class="container mx-auto px-4 mb-12" style="display: none;">
            <div class="content-card rounded-xl shadow-lg p-6 fade-in" style="animation-delay: 1.1s">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <svg class="w-8 h-8 text-blue-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    AI Trading Coach - Monthly Review
                </h2>
                
                <div id="monthlyCoachingContent" class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-6">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-green-600 mb-2">💪 Strengths</h4>
                            <ul id="monthlyStrengths" class="space-y-1 text-sm"></ul>
                        </div>
                        <div>
                            <h4 class="font-semibold text-orange-600 mb-2">🎯 Areas for Improvement</h4>
                            <ul id="monthlyImprovements" class="space-y-1 text-sm"></ul>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <h4 class="font-semibold text-purple-600 mb-2">🚀 Next Month Focus</h4>
                        <ul id="monthlyFocus" class="space-y-1 text-sm"></ul>
                    </div>
                    
                    <div class="mt-4 text-xs text-gray-500">
                        Last updated: <span id="coachingLastUpdate">N/A</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Get month and year from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        let currentMonth = parseInt(urlParams.get('month')) || new Date().getMonth() + 1;
        let currentYear = parseInt(urlParams.get('year')) || new Date().getFullYear();
        
        // Load data
        loadMonthData();
        
        async function loadMonthData() {
            try {
                // Load month-specific data
                const monthFile = `data/monthly/${currentYear}-${String(currentMonth).padStart(2, '0')}.json`;
                const response = await fetch(monthFile);
                const monthData = await response.json();
                
                displayMonthData(monthData, currentMonth, currentYear);
                setupNavigation();
            } catch (error) {
                console.error('Error loading data:', error);
                // Try loading from dashboard-data.json as fallback
                try {
                    const response = await fetch('dashboard-data.json');
                    const data = await response.json();
                    displayMonthDataFallback(data, currentMonth, currentYear);
                    setupNavigation();
                } catch (fallbackError) {
                    console.error('Error loading fallback data:', fallbackError);
                    // Display no data available
                    displayNoData(currentMonth, currentYear);
                    setupNavigation();
                }
            }
        }
        
        function displayMonthData(data, month, year) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Update title
            document.getElementById('monthTitle').textContent = `${monthNames[month - 1]} ${year}`;
            
            // Update metrics from overview
            animateValue('monthPnl', 0, data.overview.netPnL, 1000, true);
            animateValue('monthTrades', 0, data.overview.totalTrades, 1000);
            animateValue('monthWinRate', 0, data.overview.winRate * 100, 1000, false, '%');
            
            // Calculate best and worst days from profitability curve
            let bestDayPnL = 0;
            let worstDayPnL = 0;
            
            if (data.performanceAnalysis && data.performanceAnalysis.profitability_curve) {
                data.performanceAnalysis.profitability_curve.forEach(day => {
                    if (day.daily_pnl > bestDayPnL) bestDayPnL = day.daily_pnl;
                    if (day.daily_pnl < worstDayPnL) worstDayPnL = day.daily_pnl;
                });
            }
            
            if (bestDayPnL > 0) {
                document.getElementById('bestDay').textContent = `$${bestDayPnL.toFixed(2)}`;
                document.getElementById('bestDay').className = 'text-2xl font-bold text-green-600';
            } else {
                document.getElementById('bestDay').textContent = 'N/A';
                document.getElementById('bestDay').className = 'text-2xl font-bold text-gray-400';
            }
            
            if (worstDayPnL < 0) {
                document.getElementById('worstDay').textContent = `$${worstDayPnL.toFixed(2)}`;
                document.getElementById('worstDay').className = 'text-2xl font-bold text-red-600';
            } else {
                document.getElementById('worstDay').textContent = 'N/A';
                document.getElementById('worstDay').className = 'text-2xl font-bold text-gray-400';
            }
            
            document.getElementById('tradingDays').textContent = data.overview.totalTradingDays || 0;
            
            // Create calendar
            if (data.dailyData) {
                createMonthCalendar(data.dailyData, month, year);
            } else if (data.performanceAnalysis && data.performanceAnalysis.profitability_curve) {
                // Create dailyData from profitability curve
                const dailyData = {};
                data.performanceAnalysis.profitability_curve.forEach(item => {
                    dailyData[item.date] = {
                        trades: item.daily_pnl !== 0 ? 1 : 0,
                        pnl: item.daily_pnl
                    };
                });
                createMonthCalendar(dailyData, month, year);
            }
            
            // Create daily chart if data available
            if (data.dailyData) {
                createDailyChart(data.dailyData, month, year);
            } else if (data.performanceAnalysis && data.performanceAnalysis.profitability_curve) {
                // Use profitability curve data to create chart
                const dailyData = {};
                data.performanceAnalysis.profitability_curve.forEach(item => {
                    dailyData[item.date] = {
                        trades: item.daily_pnl !== 0 ? 1 : 0,
                        pnl: item.daily_pnl
                    };
                });
                createDailyChart(dailyData, month, year);
            }
            
            // Populate top trades
            if (data.topWinners && data.topLosers) {
                populateMonthlyTradesTable('monthlyWinners', data.topWinners);
                populateMonthlyTradesTable('monthlyLosers', data.topLosers);
            } else {
                // Show no data message
                document.getElementById('monthlyWinners').innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">No data available</td></tr>';
                document.getElementById('monthlyLosers').innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">No data available</td></tr>';
            }
            
            // Load coaching data
            loadMonthlyCoaching(month, year);
        }
        
        function displayMonthDataFallback(data, month, year) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Update title
            document.getElementById('monthTitle').textContent = `${monthNames[month - 1]} ${year}`;
            
            // Find month data
            const monthData = data.monthlyData ? data.monthlyData.find(m => m.month === month && m.year === year) : null;
            
            if (monthData) {
                // Update metrics
                animateValue('monthPnl', 0, monthData.pnl, 1000, true);
                animateValue('monthTrades', 0, monthData.trades, 1000);
                animateValue('monthWinRate', 0, monthData.winRate * 100, 1000, false, '%');
            } else {
                // No data for this month
                displayNoData(month, year);
                return;
            }
            
            // Calculate daily stats for the month
            const dailyStats = calculateMonthlyDailyStats(data.yearData, month, year);
            
            if (dailyStats.bestDay) {
                document.getElementById('bestDay').textContent = `$${dailyStats.bestDayPnl.toFixed(2)}`;
                document.getElementById('bestDay').className = 'text-2xl font-bold text-green-600';
            }
            
            if (dailyStats.worstDay) {
                document.getElementById('worstDay').textContent = `$${dailyStats.worstDayPnl.toFixed(2)}`;
                document.getElementById('worstDay').className = 'text-2xl font-bold text-red-600';
            }
            
            document.getElementById('tradingDays').textContent = dailyStats.tradingDays;
            
            // Create calendar
            createMonthCalendar(data.yearData, month, year);
            
            // Create daily chart
            createDailyChart(data.yearData, month, year);
            
            // Load top trades
            loadMonthlyTopTrades(month, year);
        }
        
        function calculateMonthlyDailyStats(yearData, month, year) {
            let bestDay = null;
            let worstDay = null;
            let bestDayPnl = -Infinity;
            let worstDayPnl = Infinity;
            let tradingDays = 0;
            
            Object.keys(yearData).forEach(date => {
                const dateObj = new Date(date);
                if (dateObj.getMonth() + 1 === month && dateObj.getFullYear() === year) {
                    const dayData = yearData[date];
                    if (dayData.trades > 0) {
                        tradingDays++;
                        if (dayData.pnl > bestDayPnl) {
                            bestDayPnl = dayData.pnl;
                            bestDay = date;
                        }
                        if (dayData.pnl < worstDayPnl) {
                            worstDayPnl = dayData.pnl;
                            worstDay = date;
                        }
                    }
                }
            });
            
            return {
                bestDay,
                worstDay,
                bestDayPnl,
                worstDayPnl,
                tradingDays
            };
        }
        
        function createMonthCalendar(dailyData, month, year) {
            const calendar = document.getElementById('monthCalendar');
            calendar.innerHTML = '';
            
            // Day headers
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const header = document.createElement('div');
                header.className = 'text-center font-medium text-gray-600 text-sm py-2';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            // Get first day of month
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);
            const startDay = firstDay.getDay();
            
            // Empty cells for days before month starts
            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement('div');
                calendar.appendChild(emptyCell);
            }
            
            // Days of the month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = dailyData[dateStr] || { trades: 0, pnl: 0 };
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day bg-white border-2 rounded-lg p-3 text-center';
                
                if (dayData.trades > 0) {
                    dayCell.className += dayData.pnl >= 0 ? ' border-green-200 hover:border-green-400' : ' border-red-200 hover:border-red-400';
                    dayCell.innerHTML = `
                        <div class="font-bold text-lg mb-1">${day}</div>
                        <div class="text-xs text-gray-600">${dayData.trades} trades</div>
                        <div class="${dayData.pnl >= 0 ? 'text-green-600' : 'text-red-600'} font-semibold text-sm">
                            ${dayData.pnl >= 0 ? '+' : ''}$${dayData.pnl.toFixed(2)}
                        </div>
                    `;
                } else {
                    dayCell.className += ' border-gray-200';
                    dayCell.innerHTML = `
                        <div class="font-bold text-lg text-gray-400">${day}</div>
                        <div class="text-xs text-gray-400">No trades</div>
                    `;
                }
                
                calendar.appendChild(dayCell);
            }
        }
        
        function createDailyChart(dailyDataParam, month, year) {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            // Get daily data for the month
            const chartData = [];
            const labels = [];
            
            const lastDay = new Date(year, month, 0).getDate();
            
            for (let day = 1; day <= lastDay; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = dailyDataParam[dateStr];
                
                if (dayData && dayData.trades > 0) {
                    labels.push(day);
                    chartData.push(dayData.pnl);
                }
            }
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily P&L',
                        data: chartData,
                        backgroundColor: chartData.map(val => val >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                        borderColor: chartData.map(val => val >= 0 ? 'rgb(16, 185, 129)' : 'rgb(239, 68, 68)'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'P&L: $' + context.raw.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            title: {
                                display: true,
                                text: 'Day of Month'
                            }
                        }
                    }
                }
            });
        }
        
        async function loadMonthlyTopTrades(month, year) {
            // Collect all trades for the month
            const monthlyTrades = [];
            
            // Iterate through all days of the month
            const lastDay = new Date(year, month, 0).getDate();
            
            for (let day = 1; day <= lastDay; day++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayFile = `exports/daily/${dateStr}.json`;
                
                try {
                    const response = await fetch(dayFile);
                    if (response.ok) {
                        const dayData = await response.json();
                        if (dayData.trades) {
                            monthlyTrades.push(...dayData.trades);
                        }
                    }
                } catch (error) {
                    // File doesn't exist or error loading
                }
            }
            
            // Sort trades by P&L
            const sortedTrades = monthlyTrades.sort((a, b) => (b.net || b.pnl) - (a.net || a.pnl));
            
            // Get top 5 winners and losers
            const winners = sortedTrades.filter(t => (t.net || t.pnl) > 0).slice(0, 5);
            const losers = sortedTrades.filter(t => (t.net || t.pnl) < 0).sort((a, b) => (a.net || a.pnl) - (b.net || b.pnl)).slice(0, 5);
            
            // Populate tables
            populateMonthlyTradesTable('monthlyWinners', winners);
            populateMonthlyTradesTable('monthlyLosers', losers);
        }
        
        function populateMonthlyTradesTable(tableId, trades) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';
            
            trades.forEach(trade => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                const pnl = trade.net || trade.pnl || trade.fifoPnlRealized || 0;
                
                // Determine trade type based on quantity or side
                let tradeType = trade.type;
                if (!tradeType) {
                    if (trade.side) {
                        tradeType = trade.side === 'BUY' ? 'Long' : 'Short';
                    } else if (trade.quantity !== undefined) {
                        tradeType = trade.quantity > 0 ? 'Long' : 'Short';
                    } else {
                        tradeType = 'N/A';
                    }
                }
                
                // Get date field (handle both formats)
                const tradeDate = trade.date || trade.tradeDate || '';
                
                row.innerHTML = `
                    <td class="py-3 px-2 font-medium text-gray-900">${trade.symbol || 'N/A'}</td>
                    <td class="py-3 px-2 text-gray-600">${formatDate(tradeDate)}</td>
                    <td class="py-3 px-2">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                            tradeType === 'Long' ? 'bg-blue-100 text-blue-800' : 
                            tradeType === 'Short' ? 'bg-purple-100 text-purple-800' : 
                            'bg-gray-100 text-gray-800'
                        }">
                            ${tradeType}
                        </span>
                    </td>
                    <td class="py-3 px-2 text-right font-medium ${pnl >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${pnl >= 0 ? '+' : ''}$${Math.abs(pnl).toFixed(2)}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function displayNoData(month, year) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Update title
            document.getElementById('monthTitle').textContent = `${monthNames[month - 1]} ${year}`;
            
            // Update all metrics to show no data
            document.getElementById('monthPnl').textContent = '$0.00';
            document.getElementById('monthPnl').className = 'text-3xl font-bold text-gray-400';
            document.getElementById('monthTrades').textContent = '0';
            document.getElementById('monthWinRate').textContent = '0%';
            document.getElementById('bestDay').textContent = 'N/A';
            document.getElementById('bestDay').className = 'text-2xl font-bold text-gray-400';
            document.getElementById('worstDay').textContent = 'N/A';
            document.getElementById('worstDay').className = 'text-2xl font-bold text-gray-400';
            document.getElementById('tradingDays').textContent = '0';
            
            // Show no data message in calendar
            const calendarContainer = document.querySelector('.calendar-container');
            if (calendarContainer) {
                calendarContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No trading data available for this month</div>';
            }
            
            // Show no data in charts
            const chartContainer = document.getElementById('dailyChart');
            if (chartContainer) {
                chartContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No data to display</div>';
            }
            
            // Show no data in trade tables
            document.getElementById('monthlyWinners').innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">No trades available</td></tr>';
            document.getElementById('monthlyLosers').innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-4">No trades available</td></tr>';
        }
        
        async function loadMonthlyCoaching(month, year) {
            try {
                // Load dashboard data to check for coaching
                const response = await fetch('dashboard-data.json');
                const data = await response.json();
                
                if (data.coaching && data.coaching.enabled && data.coaching.monthly) {
                    // Find coaching for this month
                    const monthStr = `${year}-${String(month).padStart(2, '0')}`;
                    const monthlyCoaching = data.coaching.monthly.find(c => c.period === monthStr);
                    
                    if (monthlyCoaching) {
                        displayMonthlyCoaching(monthlyCoaching);
                    }
                }
            } catch (error) {
                console.error('Error loading coaching data:', error);
            }
        }
        
        function displayMonthlyCoaching(monthlyData) {
            const coaching = monthlyData.coaching;
            if (!coaching) return;
            
            // Show coaching section
            document.getElementById('coachingSection').style.display = 'block';
            
            // Populate strengths
            const strengthsList = document.getElementById('monthlyStrengths');
            strengthsList.innerHTML = '';
            (coaching.strengths || []).forEach(strength => {
                const li = document.createElement('li');
                li.textContent = strength;
                li.className = 'text-green-700 dark:text-green-300';
                strengthsList.appendChild(li);
            });
            
            // Populate improvements
            const improvementsList = document.getElementById('monthlyImprovements');
            improvementsList.innerHTML = '';
            (coaching.areas_for_improvement || []).forEach(improvement => {
                const li = document.createElement('li');
                li.textContent = improvement;
                li.className = 'text-orange-700 dark:text-orange-300';
                improvementsList.appendChild(li);
            });
            
            // Populate focus areas
            const focusList = document.getElementById('monthlyFocus');
            focusList.innerHTML = '';
            (coaching.next_month_focus || []).forEach(focus => {
                const li = document.createElement('li');
                li.textContent = focus;
                li.className = 'text-purple-700 dark:text-purple-300';
                focusList.appendChild(li);
            });
            
            // Update last update time
            if (monthlyData.generated_at) {
                const date = new Date(monthlyData.generated_at);
                document.getElementById('coachingLastUpdate').textContent = date.toLocaleDateString();
            }
        }
        
        function setupNavigation() {
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 1) {
                    currentMonth = 12;
                    currentYear--;
                }
                window.location.href = `month.html?month=${currentMonth}&year=${currentYear}`;
            });
            
            document.getElementById('nextMonth').addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 12) {
                    currentMonth = 1;
                    currentYear++;
                }
                window.location.href = `month.html?month=${currentMonth}&year=${currentYear}`;
            });
        }
        
        function animateValue(id, start, end, duration, isCurrency = false, suffix = '') {
            const element = document.getElementById(id);
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                
                let displayValue = current;
                if (isCurrency) {
                    element.textContent = '$' + displayValue.toFixed(2);
                    element.className = 'text-2xl font-bold ' + (displayValue >= 0 ? 'text-green-600' : 'text-red-600');
                } else {
                    element.textContent = displayValue.toFixed(suffix === '%' ? 1 : 0) + suffix;
                }
            }, 16);
        }
        
        function formatDate(dateStr) {
            // Handle different date formats
            let date;
            if (dateStr && dateStr.length === 8) {
                // IBKR format: "20250725"
                const year = dateStr.substr(0, 4);
                const month = dateStr.substr(4, 2);
                const day = dateStr.substr(6, 2);
                date = new Date(year + '-' + month + '-' + day);
            } else {
                // PropReports format: "2025-07-25"
                date = new Date(dateStr);
            }
            
            if (isNaN(date.getTime())) {
                return 'N/A';
            }
            
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }
        
        // Dark mode functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update toggle button icon
            const button = document.querySelector('.theme-toggle svg');
            if (newTheme === 'dark') {
                button.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
            } else {
                button.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
            }
        }
        
        // Load saved theme on page load
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            if (savedTheme === 'dark') {
                window.addEventListener('DOMContentLoaded', function() {
                    const button = document.querySelector('.theme-toggle svg');
                    button.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
                });
            }
        })();
    </script>
</body>
</html>